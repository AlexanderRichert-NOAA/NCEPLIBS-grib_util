SHELL=/bin/sh

####################################################################################################
#
# wgrib2 v2.0.5 for WCOSS IBM iDataPlex using module compile for production
# 
# wgrib2 option used:
#	NetCDF		turned on
#	REGEX		turned on
#	TIGGE		turned on
#	IPOLATES	turned on
#	OPENMP		turned on
#	G2CLIB		turned on
#	PNG		    turned on
#	JASPER		turned on
#
# Library used:
#	g2c, netcdf4, jasper, proj4, ip, png, geo (gctpc), z
# 
# 08/15 Lin Gan:	Convert wgrib2 v2.0.2 from tarball to module
#
#####################################################################################################
#####################################################################################################
CMD:= wgrib2
CC=icc
FC=ifort

LIBS	= ${IP_LIB4} ${SP_LIB4} ${G2C_LIB4} ${G2_LIB4} ${JASPER_LIB} ${PNG_LIB} $(netcdf) $(libhdf5_hl) -Bstatic -L${NETCDF}/lib -lnetcdf -L${HDF5}/lib -lhdf5_hl -lhdf5 -lifcore ${Z_LIB} -L${SZIP}/lib -lsz

all:=$(patsubst %.c,%.o,$(wildcard *.c))
code:=$(filter-out fnlist.o,$(all))
o=$(wildcard *.o)
h:=grb2.h wgrib2.h fnlist.h config.h
options=$(wildcard [A-Z]*.c)
CODE_TABLE_DAT=$(wildcard CodeTable_[0-9].[0-9]*.dat)

cwd:=${CURDIR}
EINC:=-L${cwd}/../../lib -lgeo -laec -lproj
PRJH:=-I${cwd}/../../include

CPPFLAGS=-Wall -Wmissing-prototypes -Wold-style-definition -Werror=format-security -O3 -openmp -openmp-link static ${NETCDF_CFLAGS} ${PRJH} -I${JASPER_SRC} -I${Z_SRC} -I${PNG_SRC} -I${G2C_SRC} -DIFORT

FLAGS=${CPPFLAGS}

wgrib2: $h ${all} fnlist.c
	$(CC) -o wgrib2 ${FLAGS} ${all} ${FLIB} ${EINC} ${LIBS} -D__64BIT__ 
	rm Config.o

fnlist.c:	${options}
	./function.sh

fnlist.h:	${options}
	./function.sh

Help.o:	Help.c wgrib2.h
	$(CC) -c ${FLAGS} Help.c

CodeTable.o:	CodeTable.c ${CODE_TABLE_DAT}
	$(CC) -c ${FLAGS} CodeTable.c

cname.o:	cname.c
	$(CC) -c ${FLAGS} cname.c

Sec1.o:	Sec1.c code_table0.dat ncep_tableC.dat
	$(CC) -c ${FLAGS} Sec1.c

gribtab.o:	gribtab.c gribtab.dat misc_gribtab.dat NDFD_gribtab.dat
	$(CC) -c ${FLAGS} gribtab.c

Mod_grib.o:	Mod_grib.c NCEP_local_levels_test.h
	$(CC) -c ${FLAGS} Mod_grib.c

GDT.o:	GDT.c
	$(CC) -c -D__64BIT__ ${FLAGS} GDT.c

jpeg_pk.o:	jpeg_pk.c
	$(CC) -c -D__64BIT__ ${FLAGS} jpeg_pk.c

unpk.o:	unpk.c
	$(CC) -c -D__64BIT__ ${FLAGS} unpk.c

.c.o:	$(*).c
	$(CC) -c ${FLAGS} $*.c

install:
	mkdir -p ../../../../exec
	cp -p $(CMD) ../../../../exec

clean:
	-rm -f *.o wgrib2
