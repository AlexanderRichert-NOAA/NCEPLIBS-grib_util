SHELL=/bin/sh

####################################################################################################
#
# wgrib2 v2.0.2 using module compile for production
# 
# wgrib2 option used:
#	NetCDF		turned on
#	REGEX		turned on
#	TIGGE		turned on
#	IPOLATES	turned on
#	OPENMP		turned on
#	G2CLIB		turned on
#	PNG		turned on
#	JASPER		turned on
#
# Library used:
#	libg2c_v1.4.0.a, libgrib2c.a, libnetcdf.a, libnetcdf.la
#	libjasper.a, libproj.a, libipolate.a
#	libpng.a, libgeo.a, libz.a
#	
# 
# 08/15 Lin Gan:	Convert wgrib2 v2.0.2 from tarball to module
#
#####################################################################################################
#####################################################################################################
CMD:= wgrib2
export CC=cc
export FC=ftn

FC	= ${COMP}
LIBS	= ${IP_LIB4} ${G2C_LIB4} ${G2_LIB4} ${JASPER_LIB} ${PNG_LIB} ${Z_LIB} ${NETCDF_LDFLAGS}

all:=$(patsubst %.c,%.o,$(wildcard *.c))
code:=$(filter-out fnlist.o,$(all))
o=$(wildcard *.o)
h:=grb2.h  wgrib2.h fnlist.h config.h
options=$(wildcard [A-Z]*.c)
CODE_TABLE_DAT=$(wildcard CodeTable_[0-9].[0-9]*.dat)

cwd:=${CURDIR}
EINC:=-L${cwd}/../../lib -lgeo -lipolate
PRJH:=-I${cwd}/../../include
#FLIB:=-L/opt/gcc/4.4.4/snos/lib64 -lgfortran -lirc -lsvml
FLIB:=-lgfortran

CPPFLAGS=-Wall -Wmissing-prototypes -Wold-style-definition -Werror=format-security -ffast-math  -O3 ${NETCDF_CFLAGS} ${PRJH} -I${JASPER_SRC} -I${Z_SRC} -I${PNG_SRC} -I${G2C_SRC} -DGFORTRAN

FLAGS=${CPPFLAGS} -craype-verbose

wgrib2: $h ${all} fnlist.c
	${CC} -o wgrib2 ${FLAGS} ${all} ${FLIB} ${EINC} ${LIBS} -D__64BIT__
	rm Config.o
	cp $(CMD) ../../exec/$(CMD)

fnlist.c:	${options}
	./function.sh

fnlist.h:	${options}
	./function.sh

Help.o:	Help.c wgrib2.h
	${CC} -c ${FLAGS} Help.c

CodeTable.o:	CodeTable.c ${CODE_TABLE_DAT}
	${CC} -c ${FLAGS} CodeTable.c

cname.o:	cname.c
	${CC} -c ${FLAGS} cname.c

Sec1.o:	Sec1.c code_table0.dat ncep_tableC.dat
	${CC} -c ${FLAGS} Sec1.c

gribtab.o:	gribtab.c gribtab.dat misc_gribtab.dat NDFD_gribtab.dat
	${CC} -c ${FLAGS} gribtab.c

Mod_grib.o:	Mod_grib.c NCEP_local_levels_test.h
	${CC} -c ${FLAGS} Mod_grib.c

GDT.o:	GDT.c
	${CC} -c -D__64BIT__ ${FLAGS} GDT.c

jpeg_pk.o:	jpeg_pk.c
	${CC} -c -D__64BIT__ ${FLAGS} jpeg_pk.c

unpk.o:	unpk.c
	${CC} -c -D__64BIT__ ${FLAGS} unpk.c

.c.o:	$(*).c
	$(CC) -c ${FLAGS} $*.c

clean:
	-rm -f *.o wgrib2
